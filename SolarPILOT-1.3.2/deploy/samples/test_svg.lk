var("solarfield.0.des_sim_ndays", 4);
var("solarfield.0.tht", 125);
var("solarfield.0.q_des", 300 );
//var("fluxsim.0.y_res", 25 );
var("heliostat.0.width", 4);
var("heliostat.0.height", 4);
var("receiver.0.rec_height", 15);
var("receiver.0.rec_diameter", 12);

//layout_ok = run_layout({'nthreads'=3});

all = get_heliostats('cartesian', [-10000,10000,-10000,10000]);
allrefl = [];
for(i=0; i<#all; i++)
	allrefl[i] = 0.;
	
modify_heliostats(all, {"reflectivity"=allrefl});

NREL = "2 2;-500 -400;"
	+ ";m 137.62724,-0.0073085 -37.60839,0 -64.239209,-103.8804915 0,103.8804915 -35.77880068253,0 0,-151.3483915 46.65474168253,0 55.192868,86.702607 0,-86.702607 35.77879,0 0,151.3483915 z"
	+ ";m 261.32837,-105.00589 q 0,-5.69208 -2.33781,-9.75785 -2.33781,-4.06578 -8.0299,-6.40359 -3.96413,-1.62631 -9.24963,-1.93125 -5.28551,-0.40657 -12.29896,-0.40657 l -14.12857,0 0,40.759375 11.99403,0 q 9.35128,0 15.65322,-0.91479 6.30195,-0.914798 10.57102,-4.167422 4.06577,-3.150971 5.89537,-6.911813 1.93123,-3.862483 1.93123,-10.26608 z m 60.88495,104.9985815 -47.67118,0 -41.26759,-55.4977975 -17.99105,0 0,55.4977975 -38.82813,0 0,-151.3483915 65.45894,0 q 13.41706,0 23.07326,1.52467 9.65621,1.52465 18.09269,6.60687 8.53813,5.08223 13.51869,13.21376 5.08222,8.02991 5.08222,20.22723 0,16.771313 -7.82661,27.342323 -7.72497,10.571006 -22.15846,17.584464 l 50.51722,64.8490745 z"
	+ ";m 448.96377,-0.0073085 -109.47091,0 0,-151.3483915 109.47091,0 0,29.27356 -70.64279,0 0,26.122594 65.56058,0 0,29.273565 -65.56058,0 0,37.405115 70.64279,0 0,29.2735575 z"
	+ ";m 590.96091,-0.0073085 -109.16597,0 0,-151.3483915 39.03139,0 0,122.074834 70.13458,0 0,29.2735575 z";


SolarPILOT = "2.5 2.5;-900 100;"
	+ ";m 73.795785,-28.584961 q 0,12.592431 -10.703567,20.4913203 -10.646329,7.84165058 -28.962593,7.84165058 -10.58909,0 -18.487979,-1.83162638 Q 7.7999956,-3.9724813 0.93139653,-6.8343976 l 0,-20.4340824 2.40400967,0 q 6.8113608,5.437641 15.2253948,8.356796 8.471272,2.919154 16.255684,2.919154 2.003342,0 5.265926,-0.34343 3.262585,-0.34343 5.323164,-1.144766 2.518487,-1.03029 4.12116,-2.575725 1.659911,-1.545435 1.659911,-4.579066 0,-2.804678 -2.404009,-4.808019 -2.346772,-2.06058 -6.925838,-3.148108 -4.808019,-1.144767 -10.188422,-2.117818 -5.323164,-1.03029 -10.016707,-2.575725 -10.760805,-3.491538 -15.5115859,-9.444323 -4.6935426,-6.010025 -4.6935426,-14.881965 0,-11.905572 10.6463285,-19.403792 10.703567,-7.555459 27.474396,-7.555459 8.414034,0 16.599115,1.659911 8.242318,1.602673 14.252343,4.063921 l 0,19.632746 -2.346772,0 q -5.151449,-4.12116 -12.64967,-6.868599 -7.440982,-2.804678 -15.225394,-2.804678 -2.74744,0 -5.494879,0.400668 -2.690202,0.34343 -5.208688,1.37372 -2.232295,0.858575 -3.834968,2.632963 -1.602673,1.71715 -1.602673,3.949444 0,3.377062 2.575725,5.208688 2.575724,1.774388 9.730515,3.262585 4.693543,0.973051 8.986417,1.888864 4.350113,0.915813 9.329847,2.518487 9.787754,3.205346 14.424058,8.757463 4.693543,5.49488 4.693543,14.309582 z"
	+ ";m 153.47154,-33.908126 q 0,15.855017 -9.27261,25.0131487 -9.21537,9.10089378 -25.92896,9.10089378 -16.71359,0 -25.986203,-9.10089378 -9.215371,-9.1581317 -9.215371,-25.0131487 0,-15.969492 9.272609,-25.070386 9.329845,-9.100894 25.928965,-9.100894 16.82806,0 25.9862,9.158132 9.21537,9.158132 9.21537,25.013148 z m -25.35658,15.626063 q 2.00334,-2.461248 2.97639,-5.895547 1.03029,-3.491538 1.03029,-9.616039 0,-5.666594 -1.03029,-9.501562 -1.03029,-3.834968 -2.86191,-6.124501 -1.83163,-2.346771 -4.40736,-3.319823 -2.57572,-0.973051 -5.55211,-0.973051 -2.9764,0 -5.32317,0.801336 -2.28953,0.801337 -4.40735,3.205347 -1.88886,2.232294 -3.03363,6.1245 -1.08753,3.892207 -1.08753,9.787754 0,5.265926 0.97305,9.158132 0.97305,3.834968 2.86192,6.181739 1.83163,2.232295 4.35011,3.262585 2.57573,1.03029 5.83831,1.03029 2.80468,0 5.32317,-0.915813 2.57572,-0.973052 4.35011,-3.205347 z"
	+ ";m 188.9593,-1.7974249 -20.60579,0 0,-89.0628341 20.60579,0 0,89.0628341 z"
	+ ";m 247.34239,-18.568254 0,-13.393768 q -4.1784,0.34343 -9.04366,0.973051 -4.86526,0.572383 -7.38374,1.37372 -3.09087,0.973051 -4.75078,2.861916 -1.60268,1.831627 -1.60268,4.865258 0,2.003341 0.34343,3.262584 0.34343,1.259244 1.71715,2.40401 1.31648,1.144767 3.14811,1.71715 1.83163,0.515145 5.72383,0.515145 3.09087,0 6.23898,-1.259243 3.20535,-1.259244 5.60936,-3.319823 z m 0,9.9594684 q -1.65991,1.2592431 -4.12116,3.0336312 -2.46125,1.7743881 -4.63631,2.804678 -3.03363,1.3737198 -6.29621,2.00334135 -3.26259,0.6868599 -7.15479,0.6868599 -9.15814,0 -15.33988,-5.66659425 -6.18173,-5.6665946 -6.18173,-14.4812966 0,-7.040314 3.1481,-11.504903 3.14811,-4.46459 8.92918,-7.040314 5.72384,-2.575725 14.19511,-3.663253 8.47127,-1.087528 17.57216,-1.602673 l 0,-0.34343 q 0,-5.323164 -4.35011,-7.326506 -4.35011,-2.060579 -12.82138,-2.060579 -5.09422,0 -10.87529,1.831626 -5.78107,1.774388 -8.29955,2.74744 l -1.88887,0 0,-15.511587 q 3.26259,-0.858574 10.58909,-2.003341 7.38375,-1.202005 14.76749,-1.202005 17.57217,0 25.35658,5.437641 7.84165,5.380403 7.84165,16.942544 l 0,43.7300811 -20.43408,0 0,-6.8113607 z"
	+ ";m 333.31437,-46.443319 -1.83163,0 q -1.31648,-0.457906 -4.23563,-0.68686 -2.91916,-0.228953 -4.86526,-0.228953 -4.40735,0 -7.78441,0.572383 -3.37706,0.572384 -7.26927,1.946103 l 0,43.0432211 -20.6058,0 0,-64.2786391 20.6058,0 0,9.444323 q 6.81136,-5.838309 11.84833,-7.727174 5.03698,-1.946103 9.27261,-1.946103 1.08753,0 2.46125,0.05724 1.37372,0.05724 2.40401,0.171715 l 0,19.632745 z"
	+ ";m 416.59613,-60.123279 q 0,5.723833 -2.00334,11.218712 -2.00334,5.437641 -5.72384,9.158132 -5.09421,5.036973 -11.39042,7.612698 -6.23898,2.575724 -15.56883,2.575724 l -13.67996,0 0,27.7605881 -21.97951,0 0,-85.2278671 36.17462,0 q 8.12784,0 13.67996,1.430959 5.60935,1.373719 9.90223,4.178397 5.15145,3.377062 7.84165,8.642987 2.74744,5.265926 2.74744,12.64967 z m -22.72362,0.515145 q 0,-3.606014 -1.9461,-6.181739 -1.9461,-2.632963 -4.52183,-3.663253 -3.4343,-1.373719 -6.69688,-1.488196 -3.26259,-0.171715 -8.70023,-0.171715 l -3.77773,0 0,25.528293 6.29622,0 q 5.60936,0 9.21537,-0.68686 3.66325,-0.68686 6.1245,-2.747439 2.11782,-1.831627 3.03363,-4.350113 0.97305,-2.575725 0.97305,-6.238978 z"
	+ ";m 478.18456,-1.7974249 -49.91182,0 0,-15.1109181 13.96615,0 0,-55.006031 -13.96615,0 0,-15.110918 49.91182,0 0,15.110918 -13.96615,0 0,55.006031 13.96615,0 0,15.1109181 z"
	+ ";m 557.6886,-1.7974249 -61.47396,0 0,-85.2278671 21.97952,0 0,68.743229 39.49444,0 0,16.4846381 z"
	+ ";m 653.7345,-44.382739 q 0,20.376844 -11.67662,32.396892 -11.67662,11.96281018 -32.28241,11.96281018 -20.54856,0 -32.22518,-11.96281018 -11.67662,-12.020048 -11.67662,-32.396892 0,-20.548559 11.67662,-32.454131 11.67662,-11.96281 32.22518,-11.96281 20.49132,0 32.22518,11.96281 11.73385,11.905572 11.73385,32.454131 z m -29.13431,21.578849 q 3.20535,-3.892206 4.75079,-9.158132 1.54543,-5.323165 1.54543,-12.477955 0,-7.669936 -1.77439,-13.050339 -1.77439,-5.380402 -4.6363,-8.700225 -2.91916,-3.4343 -6.75412,-4.979734 -3.77773,-1.545435 -7.89889,-1.545435 -4.1784,0 -7.89889,1.488196 -3.66326,1.488197 -6.75413,4.922496 -2.86191,3.205347 -4.69354,8.871941 -1.77439,5.609356 -1.77439,13.050338 0,7.612697 1.71715,12.9931 1.77439,5.323164 4.63631,8.700225 2.86191,3.377061 6.69688,4.979735 3.83497,1.602673 8.07061,1.602673 4.23563,0 8.0706,-1.602673 3.83497,-1.659912 6.69688,-5.094211 z"
	+ ";m 737.13072,-70.540654 -26.61582,0 0,68.7432291 -21.97952,0 0,-68.7432291 -26.61582,0 0,-16.484638 75.21116,0 0,16.484638 z";


hels1 = get_heliostats("svg", SolarPILOT); 
hels2 = get_heliostats("svg", NREL);

hels = [];
for(i=0; i<#hels1; i++)
	hels[i] = hels1[i];
for(i=0; i<#hels2; i++)
	hels[#hels1+i] = hels2[i];

refls = [];
for(i=0; i<#hels; i++)
	refls[i] = 1.0;

modify_heliostats(hels, {"reflectivity"=refls});

sim_ok = run_performance();

/*
flux = get_fluxmap();

ny = #flux;
nx = #flux[0];
out(ny, nx);
dx = 1./nx;
dy = 1./ny;

xarr = [];
yarr = [];
for(i=0; i<ny; i++)
{
	xarr[i] = [];
	yarr[i] = [];
	for(j=0; j<nx; j++)
	{
		xarr[i][j] = dx*j;
		yarr[i][j] = dy*i;
	}
}

copts = {};
copts{'filled'} = true;
copts{'levels'} = 40;
copts{'colormap'} = 'parula';
contour(xarr, yarr, flux, copts);

*/